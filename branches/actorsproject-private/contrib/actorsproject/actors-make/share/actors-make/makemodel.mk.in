# makemodel.mk - elaborate, compile and link a CAL network/model
#                Assumed to be used in sub-make from main Makefile

# delete the built-in suffixes to avoid surprises
.SUFFIXES:   

ifeq "$(strip $(MODEL))" ""
  $(error MODEL not set)
endif

EXE?=$(MODEL)
srcdir?=.

.PHONY: all
all: $(EXE)

include $(MODEL).depend

CFLAGS += "-I$(ACTORS_INCLUDE)"
ifdef DEBUG
CFLAGS += -DDEBUG
endif

ifdef PRESERVE_ALL
PRESERVE_C=Y
endif

ifdef STATIC
# override inherited LDFLAGS, -Wl--rpath stuff confuses static linking
LDFLAGS = -static -L$(ACTORS_LIB) -lactors-rts -lpthread
endif

ifdef PROFILE
CFLAGS += -pg -fno-omit-frame-pointer
LDFLAGS += -pg
endif

ifeq ($(GTK), y)
LDFLAGS += `gtk-config --libs`
endif

ifeq ($(SDL), y)
LDFLAGS += `sdl-config --libs`
endif

#
# We get the actor instances from the CALML-files 
# (we have to do elaboration first, to get *.calml).
#

ACTOR_C_FILES=$(XLIM_FILES:.xlim=.c)
PAR_FILES=$(XLIM_FILES:.xlim=.par)
OBJECTS=$(ACTOR_C_FILES:.c=.o) $(MODEL).o

$(EXE): $(OBJECTS)
	$(CC) $^ $(LDFLAGS) -o $@

#
# Implicit rules .xlim -> .c -> .o
#

%.o : %.c
	$(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ $<

ifdef PRESERVE_C
.SECONDARY: $(ACTOR_C_FILES)
endif

%.c : %.xlim
	$(XLIM2C) $< $@

#
# Generate network configuration from .xdf
#
$(MODEL).c: $(MODEL).xdf
	$(SAXON8) -o $@ $< $(GENERATECONFIG_XSL)

#
# Generate .xlim from .cal and .par
# (dependence of .xlim on .cal and .par is given by $(MODEL).depend)
#
$(XLIM_FILES): %.xlim :
	$(SSAGENERATOR) -mp "$(srcdir)" `cat $(basename $(@F)).par` $(<F)
	mv $(basename $(<F)).xlim $@

#
# Generate parameter (.par) files from $(MODEL).xdf
# (dependence of .par files on $(MODEL).xdf via $(MODEL).timestamp)
#

$(PAR_FILES): $(MODEL).timestamp

$(MODEL).timestamp: $(MODEL).xdf
	$(XDF2PAR) $<
	@touch $@

#
# Generate dependences from .xdf
#
$(MODEL).depend: $(MODEL).xdf
	$(SAXON8) -o $@ $< $(XDF2DEPEND_XSL)


#
# Generate xdf from network (nl) files
# (dependence of $(MODEL).xdf on network (.nl) files is
#  given in $(MODEL).depend). 
#
$(MODEL).xdf: $(srcdir)/$(MODEL).nl $(SUB_NETWORKS)
	$(ELABORATOR) -mp $(srcdir) $(MODEL)

.PHONY: clean

clean:
	rm -f $(EXE) $(MODEL).xdf $(MODEL).depend $(MODEL).timestamp \
            *.par *.xlim *.c *.o
