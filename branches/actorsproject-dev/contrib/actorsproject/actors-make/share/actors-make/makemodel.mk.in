# makemodel.mk - elaborate, compile and link a CAL network/model
#                Assumed to be used in sub-make from main Makefile

ifeq "$(strip $(MODEL))" ""
  $(error MODEL not set)
endif

EXE?=$(MODEL)
srcdir?=.

CFLAGS += "-I$(ACTORS_INCLUDE)"
ifdef DEBUG
CFLAGS += -DDEBUG
endif

ifdef PRESERVE_ALL
PRESERVE_C=Y
PRESERVE_XLIM=Y
endif

ifdef STATIC
# override inherited LDFLAGS, -Wl--rpath stuff confuses static linking
LDFLAGS = -static -L$(ACTORS_LIB) -lactors-rts -lpthread
endif

ifdef PROFILE
CFLAGS += -pg
LDFLAGS += -pg
endif

#
# We get the actor instances from the CALML-files 
# (we have to do elaboration first, to get *.calml).
#

CALML_FILES:=$(wildcard *.calml)
XLIM_FILES=$(CALML_FILES:.calml=.xlim)
ACTOR_C_FILES=$(CALML_FILES:.calml=.c)
CONFIG_FILE?=config.c
CONFIG_O=$(notdir $(CONFIG_FILE:.c=.o))
OBJECTS=$(ACTOR_C_FILES:.c=.o) $(CONFIG_O)

# delete the built-in suffixes to avoid surprises
.SUFFIXES:   

.PHONY: all clean cleaner

all: $(EXE)

$(EXE): $(OBJECTS)
	$(CC) $^ $(LDFLAGS) -o $@

#
# Implicit rules .calml -> .xlim -> .c -> .o
#

%.o : %.c
	$(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ $<

# Supports config file in different directory
$(CONFIG_O): $(CONFIG_FILE)
	$(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ $<

ifdef PRESERVE_C
.SECONDARY: $(ACTOR_C_FILES)
endif

%.c : %.xlim
	$(XLIM2C) $< $@

ifdef PRESERVE_XLIM
.SECONDARY: $(XLIM_FILES)
endif

%.xlim : %.calml
	$(SSAGENERATOR) $<
	rm -f $*.ssagenerator2.calml

# clean: removes $(EXE), objects and all intermediate build files,
#        (but keeps the elaboration, including config.c) 

clean:
	rm -f $(EXE) *.xlim $(ACTOR_C_FILES) *.o

# cleaner: also clean the elaboration

cleaner:
	rm -f $(EXE) $(MODEL).xdf *.calml *.xlim *.c *.o
