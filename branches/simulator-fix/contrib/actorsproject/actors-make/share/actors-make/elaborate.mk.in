# elaborate.mk - elaborate a CAL network/model (create instances of
#                subnetworks and actors).
#                Assumed to be used in sub-make from main Makefile

ifeq "$(strip $(MODEL))" ""
  $(error MODEL not set)
endif

# delete the built-in suffixes to avoid surprises
.SUFFIXES:   

#
# all: sets up .xdf, *.calml and config.c
#

.PHONY: all
all: $(MODEL).timestamp config.c

#
# calml.timestamp: sets up *.calml from elaborated network.
#

$(MODEL).timestamp: $(MODEL).xdf	
	@# rm -f *.calml # TODO: find a better way -not OK with actors-test
	@$(SAXON8) $< "$(XDF2CALMLS_XSL)"
	@rm -f art_*.calml  # don't build system actors 
	@touch $@

config.c: $(MODEL).xdf
	@$(SAXON8) -o $@ $< "$(GENERATECONFIG_XSL)"

# TODO: generate a dependence rule when elaborating, include it here
#       (not only the MODEL, but also submodel -in fact even actors)

$(MODEL).xdf: $(srcdir)/$(MODEL).nl 
	@$(ELABORATOR) -mp "$(srcdir)" $(MODEL)
