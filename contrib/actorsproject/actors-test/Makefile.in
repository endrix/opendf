# Top-level Makefile

# delete the built-in suffixes to avoid surprises
.SUFFIXES:   

srcdir=@datadir@/actors-test

# New categories also needs to be added in second last rule of this file
CATEGORIES=SystemActors MPEG4_SP_Decoder RVC_MPEG4_SP_Decoder

.PHONY: all report help clean FORCE $(CATEGORIES)

all: $(CATEGORIES) report

report:
	@rm -f $@
	@for test in $(CATEGORIES); do                            \
           if [ -r $$test/report ]; then                          \
             head -n 1 $$test/report >> $@ ;                      \
           else                                                   \
             echo '***' $$test report missing FAILED '***' >> $@ ;\
           fi                                                     \
         done
	@echo >> $@
	@if grep -q FAILED $@;                                    \
           then echo '*** There are FAILED tests ***' >> $@ ;     \
           else if grep -q SKIPPED $@;                            \
             then echo '*** There are SKIPPED tests ***' >> $@ ;  \
             else echo '*** All tests PASSED ***' >> $@ ;         \
           fi                                                     \
         fi
	@echo
	@echo Test Summary:
	@cat $@ 

$(CATEGORIES): % : %/all

clean:
	@rm -rf report $(CATEGORIES)

GENTARGETS=$(CATEGORIES:%=%/all)   \
           $(CATEGORIES:%=%/clean) $(CATEGORIES:%=%/cleaner)

.PHONY: $(GENTARGETS)

$(GENTARGETS):
	@mkdir -p $(@D)
	@$(MAKE) -C $(@D) -f $(srcdir)/$(@D)/Makefile \
                 srcdir=$(srcdir)/$(@D) $(@F)

FORCE:

SystemActors/% MPEG4_SP_Decoder/%: FORCE
	@mkdir -p $(@D)
	@rm -f $@.result
	@$(MAKE) -C $(@D) -f $(srcdir)/$(@D)/Makefile \
                 srcdir=$(srcdir)/$(@D) $(@F).result

help:
	@echo
	@echo Usage:
	@echo "make, make all        Execute all tests"
	@echo 'make <category>       Execute all tests in <category>'
	@echo Available categories: 
	@echo $(CATEGORIES)
	@echo 'make <category>/test  Execute a specific test only'
	@echo 'make <category>/clean Remove build files for <category>'
	@echo "make clean            Remove everything: build directories" \
                                     and reports
	@echo
