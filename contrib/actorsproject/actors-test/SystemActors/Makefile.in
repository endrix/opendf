# MPEG4_SP_Decoder module tests

# The path to the installed ACTOR-specific tools
export srcdir=@datadir@/actors-test/SystemActors

# Default definitions of tools and directories
include @datadir@/actors-make/definitions.mk

TITLE=SystemActors

ALL_TEST_MODELS=txtTest binTest #yuvTest

LOCAL_SKIP=$(filter $(SKIPPED_TEST_MODELS:$(TITLE)/%=%), $(ALL_TEST_MODELS))
RUN_TEST_MODELS=$(filter-out $(LOCAL_SKIP), $(ALL_TEST_MODELS))

# delete the built-in suffixes to avoid surprises
.SUFFIXES:   

.PHONY: all init elaborate-all clean

all: init elaborate-all report

# .calml prerequisites tell us how to build each test case
# ($^ used in make -f makemodel.mk, see below). In this way,
# we can utilize a single (time consuming) elaboration for
#  all test cases

txtTest: # just system actors no .calml:s

binTest:

yuvTest:


report: $(ALL_TEST_MODELS:%=%.result)
	@if cat $^ | grep -q FAILED;                                 \
            then echo '***' $(TITLE) FAILED '***' > $@;              \
            else if [ -n "$(LOCAL_SKIP)" ];\
              then echo '***' $(TITLE) has SKIPPED tests '***' > $@; \
              else echo '***' $(TITLE) PASSED '***' > $@;            \
            fi; \
         fi
	@echo `cat $^ | grep -c PASSED` \
              'successful test(s) in' $(TITLE) >> $@
	@echo `cat $^ | grep -c FAILED`   \
              'failed test(s) in' $(TITLE) >> $@
	@echo $(words $(LOCAL_SKIP)) 'skipped test(s) in' $(TITLE) >> $@
	@echo >> $@
	@for model in $(RUN_TEST_MODELS); \
            do cat $${model}.result $${model}.diff >> $@; done
	@for model in $(LOCAL_SKIP); \
            do cat $${model}.result >> $@; done
	@echo
	@cat $@


$(RUN_TEST_MODELS:=.result): %.result : %
	@mkdir -p output/$*
	@./$*
	@if diff -q output/$* $(srcdir)/gold/$* > $*.diff; \
            then echo $(TITLE)/$*: PASSED > $@;  \
            else echo $(TITLE)/$*: FAILED > $@; fi
	@cat $*.result $*.diff

$(LOCAL_SKIP:=.result): %.result :
	@echo $(TITLE)/$*: SKIPPED > $@
	@cat $@

$(RUN_TEST_MODELS):
	$(MAKE) -f $(ACTORS_MAKE)/makemodel.mk MODEL=$@ \
          PRESERVE_C=Y "CALML_FILES=$^" CONFIG_FILE=$(srcdir)/config-$@.c

elaborate-all: $(RUN_TEST_MODELS:%=%.timestamp)

$(RUN_TEST_MODELS:%=%.timestamp) : %.timestamp :
	@$(MAKE) -f $(ACTORS_MAKE)/elaborate.mk MODEL=$(basename $@)

init:
	@rm -f report *.result *.diff

clean: init
	@rm -f $(ALL_TEST_MODELS) *.o *.c *.xlim
	@rm -rf output

cleaner: clean
	@rm -f *.timestamp *.calml *.xdf

